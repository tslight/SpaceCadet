name: release-on-green

on:
    workflow_run:
        workflows: [CI]
        types:
            - completed

jobs:
    tag-on-green:
        if: >-
            ${{ github.event.workflow_run.conclusion == 'success' &&
                (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master') }}
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch }}
                  fetch-depth: 0

            - name: Compute next tag
              id: ver
              run: |
                  set -e
                  last=$(git tag --list 'v*' --sort=-v:refname | head -n1)
                  if [ -z "$last" ]; then
                    next="v0.0.1"
                  else
                    v=${last#v}
                    IFS='.' read -r major minor patch <<< "$v"
                    patch=$((patch+1))
                    next="v${major}.${minor}.${patch}"
                  fi
                  echo "tag=$next" >> $GITHUB_OUTPUT

            - name: Create and push tag
              env:
                  TAG: ${{ steps.ver.outputs.tag }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -e
                  sha=${{ github.event.workflow_run.head_sha }}
                  git tag -a "$TAG" -m "Release $TAG (auto tag on green)" "$sha"
                  git push origin "$TAG"
