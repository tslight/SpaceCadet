name: release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-release:
        runs-on: macos-13
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Show commit
              run: |
                  git rev-parse HEAD

            - name: Install SwiftLint (pinned)
              env:
                  SWIFTLINT_VERSION: 0.54.0
              run: |
                  set -e
                  curl -sSL -o swiftlint.zip "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/portable_swiftlint.zip"
                  unzip -q swiftlint.zip -d swiftlint-bin
                  echo "${{ github.workspace }}/swiftlint-bin" >> $GITHUB_PATH
                  swiftlint --version

            - name: Lint (Makefile)
              env:
                  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
              run: make lint-strict

            - name: Analyze (SwiftLint)
              env:
                  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
              run: |
                  set -e
                  # Produce compiler log; use xcodebuild for the app target
                  xcodebuild -project SpaceCadetApp/SpaceCadetApp.xcodeproj -scheme SpaceCadetApp -configuration Release -derivedDataPath build-app | tee xcodebuild.log || true
                  swiftlint analyze --compiler-log-path xcodebuild.log || true

            - name: Build (SPM)
              run: |
                  swift build -v

            - name: Build App (Release)
              run: |
                  xcodebuild -project SpaceCadetApp/SpaceCadetApp.xcodeproj -scheme SpaceCadetApp -configuration Release -derivedDataPath build-app

            - name: Package App Bundle (ZIP & DMG)
              run: |
                  APP_PATH=$(ls -d build-app/Build/Products/Release/Space\ Cadet.app 2>/dev/null || true)
                  if [ -z "$APP_PATH" ]; then APP_PATH=$(find build-app/Build/Products/Release -type d -name 'Space Cadet.app' | head -n 1); fi
                  if [ -z "$APP_PATH" ]; then echo 'App bundle not found'; exit 1; fi
                  mkdir -p artifacts
                  ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" artifacts/SpaceCadet.zip
                  bash scripts/build-dmg.sh "$APP_PATH" artifacts/SpaceCadet.dmg assets/dmg_background.png

            - name: Generate SHA256 Checksums
              run: |
                  cd artifacts
                  shasum -a 256 SpaceCadet.zip > SpaceCadet.zip.sha256
                  shasum -a 256 SpaceCadet.dmg > SpaceCadet.dmg.sha256

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      artifacts/SpaceCadet.zip
                      artifacts/SpaceCadet.zip.sha256
                      artifacts/SpaceCadet.dmg
                      artifacts/SpaceCadet.dmg.sha256
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Summary
              run: |
                  echo "App packaged (SpaceCadet.zip + SpaceCadet.dmg)." >> $GITHUB_STEP_SUMMARY
                  ls -lh artifacts
